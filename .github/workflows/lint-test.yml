name: ğŸ” Lint and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (UTC) ì‹¤í–‰
    - cron: '0 9 * * *'

# SARIF ì—…ë¡œë“œë¥¼ ìœ„í•œ ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  security-events: write
  actions: read

env:
  PYTHON_VERSION: '3.11'

jobs:
  lint:
    name: ğŸ¨ Code Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy black isort
          pip install -r requirements-dev.txt || echo "requirements-dev.txt not found, skipping"

      - name: ğŸ” Run Ruff Linter
        run: |
          echo "::group::Ruff Check"
          ruff check . --output-format=github
          echo "::endgroup::"
        continue-on-error: true

      - name: ğŸ¨ Check Code Formatting (Ruff)
        run: |
          echo "::group::Ruff Format Check"
          ruff format --check . || echo "âš ï¸ Code formatting issues found (non-blocking)"
          echo "::endgroup::"
        continue-on-error: true

      - name: ğŸ“‹ Type Checking (MyPy)
        run: |
          echo "::group::MyPy Type Check"
          mypy eval/ scripts/ --ignore-missing-imports --show-error-codes
          echo "::endgroup::"
        continue-on-error: true

      - name: ğŸ“Š Generate Lint Report
        if: always()
        run: |
          echo "## ğŸ” Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "### Ruff Check" >> $GITHUB_STEP_SUMMARY
          ruff check . --statistics >> $GITHUB_STEP_SUMMARY || echo "Ruff check had issues" >> $GITHUB_STEP_SUMMARY
          echo "### Format Check" >> $GITHUB_STEP_SUMMARY
          if ruff format --check .; then
            echo "Code formatting: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "Code formatting: âš ï¸ Issues found (informational)" >> $GITHUB_STEP_SUMMARY
          fi

  test:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-xdist pytest-mock
          pip install deepeval[all] lm-eval[all] || echo "Optional dependencies failed"
          pip install -r requirements-test.txt || echo "requirements-test.txt not found"

      - name: ğŸ§ª Run Unit Tests
        run: |
          pytest tests/ -v \
            --cov=eval \
            --cov=scripts \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --junit-xml=pytest-results.xml \
            -n auto
        continue-on-error: true

      - name: ğŸ“Š Upload Coverage to Codecov
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: ğŸ“‹ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.python-version }}
          path: |
            pytest-results.xml
            htmlcov/
            coverage.xml

  schema-validation:
    name: ğŸ“‹ Schema Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install jsonschema pyyaml

      - name: ğŸ“‹ Validate Dataset Manifests
        run: |
          echo "::group::Dataset Schema Validation"
          python scripts/validate_schemas.py datasets/ || echo "âš ï¸ Schema validation issues (non-blocking)"
          echo "::endgroup::"
        continue-on-error: true

      - name: ğŸ“‹ Validate Config Files
        run: |
          echo "::group::Config Validation"
          python -c "
          import yaml, json, os
          
          # Validate YAML files
          for root, dirs, files in os.walk('.'):
              for file in files:
                  if file.endswith('.yaml') or file.endswith('.yml'):
                      filepath = os.path.join(root, file)
                      try:
                          with open(filepath, 'r') as f:
                              yaml.safe_load(f)
                          print(f'âœ… {filepath}')
                      except Exception as e:
                          print(f'âŒ {filepath}: {e}')
                          
          # Validate JSON files
          for root, dirs, files in os.walk('.'):
              for file in files:
                  if file.endswith('.json'):
                      filepath = os.path.join(root, file)
                      try:
                          with open(filepath, 'r') as f:
                              json.load(f)
                          print(f'âœ… {filepath}')
                      except Exception as e:
                          print(f'âŒ {filepath}: {e}')
          "
          echo "::endgroup::"
        continue-on-error: true

  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”’ Run Bandit Security Scan
        uses: tj-actions/bandit@v5.1
        with:
          options: "-r -f json -o bandit-report.json --skip B101,B603,B607"
          targets: "."
        continue-on-error: true
          
      - name: ğŸ” Run Safety Check
        run: |
          pip install safety
          safety check --json --output safety-report.json || true

      - name: ğŸ“‹ Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  docker-lint:
    name: ğŸ³ Docker Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Lint Deepeval Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        continue-on-error: true
        with:
          dockerfile: docker/deepeval.Dockerfile
          format: sarif
          output-file: hadolint-deepeval.sarif

      - name: ğŸ” Lint Evalchemy Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        continue-on-error: true
        with:
          dockerfile: docker/evalchemy-cpu.Dockerfile
          format: sarif
          output-file: hadolint-evalchemy-cpu.sarif

      - name: ğŸ” Lint Tools Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        continue-on-error: true
        with:
          dockerfile: docker/workflow-tools.Dockerfile
          format: sarif
          output-file: hadolint-tools.sarif

      - name: ğŸ” Check Generated SARIF Files
        if: always()
        run: |
          echo "::group::SARIF Files Status"
          for file in hadolint-*.sarif; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists ($(wc -l < "$file") lines)"
            else
              echo "âŒ $file missing"
            fi
          done
          echo "::endgroup::"

      - name: ğŸ“‹ Upload Deepeval Hadolint Results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('hadolint-deepeval.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: hadolint-deepeval.sarif

      - name: ğŸ“‹ Upload Evalchemy CPU Hadolint Results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('hadolint-evalchemy-cpu.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: hadolint-evalchemy-cpu.sarif

      - name: ğŸ“‹ Upload Tools Hadolint Results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('hadolint-tools.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: hadolint-tools.sarif

      - name: ğŸ“‹ Upload Hadolint SARIF Reports as Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: hadolint-sarif-reports
          path: |
            hadolint-*.sarif

  integration-test:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”¨ Build Test Images
        run: |
          docker build -f docker/workflow-tools.Dockerfile -t test-tools . || echo "âš ï¸ Docker build issues (non-blocking)"
        continue-on-error: true

      - name: ğŸ§ª Run Integration Tests
        run: |
          # ë°ì´í„°ì…‹ ì¤‘ë³µ ì œê±° í…ŒìŠ¤íŠ¸
          docker run --rm -v $(pwd):/workspace test-tools \
            python3 /workspace/scripts/dedup_datasets.py --dry-run \
            --input-manifest /workspace/datasets/manifests/test-manifest.yaml || echo "âš ï¸ Integration test issues (non-blocking)"
        continue-on-error: true

      - name: ğŸ“Š Integration Test Summary
        run: |
          echo "## ğŸ”— Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Docker image build: âš ï¸ Informational" >> $GITHUB_STEP_SUMMARY
          echo "- Script execution: âš ï¸ Informational" >> $GITHUB_STEP_SUMMARY

  # docs-check:
  #   name: ğŸ“š Documentation Check
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #     - name: ğŸ“¥ Checkout Repository
  #       uses: actions/checkout@v4

  #     - name: ğŸ Set up Python
  #       uses: actions/setup-python@v4
  #       with:
  #         python-version: ${{ env.PYTHON_VERSION }}

  #     - name: ğŸ“¦ Install MkDocs Dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -e ".[docs]" || pip install mkdocs mkdocs-material mkdocs-mermaid2-plugin mkdocs-git-revision-date-localized-plugin "mkdocstrings[python]" mkdocs-minify-plugin
  #       continue-on-error: true

  #     - name: ğŸ” Check Documentation Build
  #       run: |
  #         mkdocs build --strict || echo "âš ï¸ Documentation build issues (non-blocking)"
  #       continue-on-error: true

  #     - name: ğŸ“‹ Check Links
  #       run: |
  #         # ê°„ë‹¨í•œ ë§í¬ ì²´í¬
  #         python -c "
  #         import re, os
  #         
  #         def check_links(directory):
  #             broken_links = []
  #             for root, dirs, files in os.walk(directory):
  #                 for file in files:
  #                     if file.endswith('.md'):
  #                         filepath = os.path.join(root, file)
  #                         try:
  #                             with open(filepath, 'r', encoding='utf-8') as f:
  #                                 content = f.read()
  #                                 # ë‚´ë¶€ ë§í¬ ì²´í¬ (ê°„ë‹¨í•œ ë²„ì „)
  #                                 links = re.findall(r'\[.*?\]\((.*?)\)', content)
  #                                 for link in links:
  #                                     if link.startswith('./') or link.startswith('../'):
  #                                         target = os.path.normpath(os.path.join(os.path.dirname(filepath), link))
  #                                         if not os.path.exists(target):
  #                                             broken_links.append(f'{filepath}: {link}')
  #                         except Exception as e:
  #                             print(f'âš ï¸ Error reading {filepath}: {e}')
  #             return broken_links
  #         
  #         broken = check_links('.')
  #         if broken:
  #             print('âš ï¸ Broken links found (informational):')
  #             for link in broken:
  #                 print(f'  {link}')
  #         else:
  #             print('âœ… All links are valid')
  #         " || echo "âš ï¸ Link check issues (non-blocking)"
  #       continue-on-error: true

  summary:
    name: ğŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [lint, test, schema-validation, security, docker-lint]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          echo "## ğŸ¯ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¨ Lint | ${{ needs.lint.result == 'success' && 'âœ… Passed' || 'âš ï¸ Issues (non-blocking)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª Test | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âš ï¸ Issues (non-blocking)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“‹ Schema | ${{ needs.schema-validation.result == 'success' && 'âœ… Passed' || 'âš ï¸ Issues (non-blocking)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”’ Security | ${{ needs.security.result == 'success' && 'âœ… Passed' || 'âš ï¸ Issues (non-blocking)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ³ Docker | ${{ needs.docker-lint.result == 'success' && 'âœ… Passed' || 'âš ï¸ Issues (non-blocking)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "â„¹ï¸ **All checks are informational and non-blocking.** Pipeline focuses on functionality over strict formatting." >> $GITHUB_STEP_SUMMARY
